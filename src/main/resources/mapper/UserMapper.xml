<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.example.springsecuritydemo.mapper.UserMapper">

    <!-- 基本映射 -->
    <resultMap id="info_user_mapper" type="com.example.springsecuritydemo.entity.User">
        <result column="id" property="id"/>
        <result column="create_time" property="createTime"/>
        <result column="update_time" property="updateTime"/>
        <result column="create_by" property="createBy"/>
        <result column="update_by" property="updateBy"/>
        <result column="version" property="version"/>
        <result column="deleted" property="deleted"/>
        <result column="extra" property="extra"/>
        <result column="weight" property="weight"/>
        <result column="tenant_id" property="tenantId"/>
        <result column="user_name" property="userName"/>
        <result column="full_name" property="fullName"/>
        <result column="password" property="password"/>
        <result column="enabled" property="enabled"/>
    </resultMap>

    <resultMap id="UserRolesMap" type="com.example.springsecuritydemo.entity.User">
        <result column="id" property="id"/>
        <result column="user_name" property="userName"/>
        <result column="full_name" property="fullName"/>
        <result column="password" property="password"/>
        <result column="enabled" property="enabled"/>
        <collection property="roles"
                    ofType="com.example.springsecuritydemo.entity.Role">
            <result column="name" property="name"/>
        </collection>
    </resultMap>

    <!-- 通用字段视图 -->
    <sql id="base_column">
        ${prefix}id,${prefix}create_time,${prefix}update_time,${prefix}create_by,${prefix}update_by,${prefix}version,${prefix}deleted,${prefix}extra,${prefix}weight,${prefix}tenant_id
    </sql>

    <!-- 表主要字段视图 -->
    <sql id="info_user_column">
        ${prefix}id,${prefix}user_name,${prefix}full_name,${prefix}password,${prefix}enabled
    </sql>
    <!-- ================================ 新增SQL ================================ -->
    <select id="getUserWithRoles" resultMap="UserRolesMap">
        select
        <include refid="info_user_column">
            <property name="prefix" value="iu."/>
        </include>
        ,dr.name
        from info_user iu,
        relation_user_role rur,
        dict_role dr
        where iu.deleted = 0
        and rur.deleted=0
        and dr.deleted=0
        and iu.user_name = #{name}
        and rur.user_id = iu.id
        and rur.role_id = dr.id;
    </select>


    <!-- ================================ 基础SQL ================================ -->
    <select id="listByIds" resultType="com.example.springsecuritydemo.entity.User">
        select
        <include refid="info_user_column">
            <property name="prefix" value="${table.name}."/>
        </include>
        ,
        <include refid="base_column">
            <property name="prefix" value="${table.name}."/>
        </include>
        from info_user where id in (
        <foreach collection="ids" item="item" separator=",">
            #{item}
        </foreach>
        )
    </select>

    <insert id="saveBatch" useGeneratedKeys="true" keyProperty="id">>
        INSERT INTO info_user
        (id,create_time,update_time,create_by,update_by,version,deleted,extra,weight,tenant_id,user_name,full_name,password,enabled)
        VALUES
        <foreach collection="objs" item="item" separator=",">
            (#{item.id},#{item.createTime},#{item.updateTime},#{item.createBy},#{item.updateBy},#{item.version},#{item.deleted},#{item.extra},#{item.weight},#{item.tenantId},#{item.userName},#{item.fullName},#{item.password},#{item.enabled})
        </foreach>
    </insert>
</mapper>
